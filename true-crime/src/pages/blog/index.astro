---
import Base from "@/layouts/Base.astro";
import HeadSEO from "@/components/HeadSEO.astro";
import { getCollection } from 'astro:content';

const posts = (await getCollection('posts', ({ data }) => !data.draft))
  .sort((a, b) => (a.data.date < b.data.date ? 1 : -1));

const renderedPosts = await Promise.all(
  posts.map(async (p) => {
    const rendered = await p.render();
    return { entry: p, Content: rendered.Content };
  })
);
---
<Base title="Blog" description="All posts">
  <HeadSEO title="Blog" description="All posts" canonical="/blog/" />
  <h1>Blog</h1>
  <section style="margin-top:1rem;">
    {renderedPosts.map(({ entry: p, Content }) => (
      <details class="card" data-slug={p.slug} id={p.slug} style="margin-bottom: 1rem; padding: 1rem;">
        <summary style="cursor:pointer; list-style: none; display:flex; align-items:baseline; gap:.75rem;">
          <h3 style="margin:0;"><a href={`#${p.slug}`} style="text-decoration:none;">{p.data.title}</a></h3>
          <span style="color:var(--muted); font-size:.9rem;">{new Date(p.data.date).toLocaleDateString()}</span>
        </summary>
        {p.data.hero && <img src={p.data.hero} alt={p.data.title} style="margin-top: .75rem;" />}
        <div style="margin-top:.75rem;">
          <Content />
        </div>
      </details>
    ))}
  </section>
  <script>
    const openFromHash = () => {
      const slug = location.hash ? location.hash.slice(1) : '';
      if (!slug) return;
      const el = document.querySelector(`details[data-slug="${slug}"]`);
      if (el) {
        el.open = true;
        el.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    };
    window.addEventListener('hashchange', openFromHash);
    openFromHash();
  </script>
</Base>


